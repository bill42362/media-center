# Caddy configuration for Media Center
# Region network (HTTP for now, can upgrade to HTTPS with Cloudflare Tunnel later)

{
    # Global options
    auto_https off
}

# Main server block
:8080 {
    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }

    # Backend GraphQL API
    handle /graphql* {
        reverse_proxy backend:3000
    }

    # Backend REST endpoints
    handle /api/* {
        reverse_proxy backend:3000
    }

    # Health check
    handle /health {
        reverse_proxy backend:3000
    }

    # HLS video streaming
    handle /stream/* {
        root * /srv/transcoded
        file_server {
            precompressed br gzip
        }
        header {
            # CORS for HLS
            Access-Control-Allow-Origin *
            Access-Control-Allow-Methods "GET, OPTIONS"
            Access-Control-Allow-Headers "Range"
            # Cache control
            Cache-Control "public, max-age=3600"
        }
    }

    # Frontend - React SPA (serve static files with SPA fallback)
    # Must be last to avoid intercepting API routes
    handle /* {
        root * /srv/frontend
        try_files {path} /index.html
        file_server
    }

    # Handle CORS preflight
    handle_path /graphql {
        @options method OPTIONS
        respond @options 204
    }
}

# Future: HTTPS with Cloudflare Tunnel
# {$DOMAIN} {
#     reverse_proxy backend:3000
# }
