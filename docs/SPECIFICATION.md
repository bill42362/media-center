# Media Center 系統規格書

## 目錄
1. [系統概述](#系統概述)
2. [硬體環境](#硬體環境)
3. [功能需求](#功能需求)
4. [技術選型](#技術選型)
5. [安全性要求](#安全性要求)
6. [效能要求](#效能要求)
7. [開發階段](#開發階段)

---

## 系統概述

本系統為私人媒體中心，提供影片、圖片、文章的管理、瀏覽、播放功能，並整合 AI 翻譯、ComfyUI 創作工具、Grafana 監控等功能。

### 核心特色
- 🏷️ 多重標籤系統（namespace::value 格式）
- 🔒 安全模式切換（SFW/NSFW 內容分離）
- 🎬 影片加密串流
- 🤖 AI 輔助翻譯（圖片漫畫、文章簡繁轉換）
- 🎨 整合 ComfyUI 用於 AI 圖片創作
- 📊 系統監控（Desktop 資源 + UPS 狀態）

### 內容規模
- **影片**：約 3000 部
- **圖片**：約 30000 張
- **文章**：約 500 篇

---

## 硬體環境

### 主要設備

| 設備 | 規格 | 用途 |
|------|------|------|
| **NAS** | Synology DS420+<br>RAM: 10GB | 主要伺服器、資料庫、媒體儲存 |
| **Desktop** | Windows<br>GPU: RTX 2080Ti<br>WSL2 + Docker | ComfyUI 伺服器、AI 翻譯伺服器 |
| **Router** | ASUS RT-AX56U<br>Firmware: Merlin 3004.388.6_2 | 網路管理 |
| **UPS** | APC Back-UPS NS 650M1 | 停電保護、狀態監控 |

### 網路架構
- **區網訪問**：`http://192.168.50.100:8080`（Caddy 統一入口）
- **反向代理**：Caddy
  - `/` → Media Center (port 3000)
  - `/comfyui` → ComfyUI (未來)
  - `/grafana` → Grafana (未來)
- **未來公網**（可選）：
  - Cloudflare Tunnel（零信任架構）
  - 不開放任何 Router Port
  - 自動 HTTPS

### 儲存規劃
- **媒體來源**：支援多個資料夾作為媒體來源
  - 範例：`/volume1/media/`, `/volume1/downloads/`, `/volume1/family/`
  - 透過配置檔案管理，無需修改程式碼
  - 新增資料夾後重啟服務即可生效
- **轉碼結果**：
  - 最愛影片：永久儲存於 HDD
  - 非最愛影片：快取於 Ramdisk (6GB)
- **Ramdisk 用途**：
  - Session 和快取資料
  - 非最愛影片 HLS 切片（約可快取 40-80 部）
  - 資料庫寫入緩衝（Grafana 時間序列資料）

---

## 功能需求

### 1. 認證與授權

#### Email OTP 登入
- 使用者輸入 Email，系統發送 6 位數 OTP
- OTP 有效期限：10 分鐘
- 使用 Gmail SMTP 發送郵件
- 登入後建立 Session
- 未登入使用者無法觀看任何內容

#### 安全模式
- **安全模式 (SFW)**：只顯示 `mode::SFW` 標籤的內容
- **非安全模式**：顯示所有內容
- 切換至非安全模式需要再次 OTP 驗證或 WebAuthn

#### WebAuthn（第二階段）
- 支援平台認證器（Touch ID, Face ID, Windows Hello）
- 用於快速解鎖非安全模式

---

### 2. 標籤系統

所有內容都支援多重標籤，格式：`namespace::value`

**標籤範例**：
- `author::手塚治虫`
- `director::Ang Lee`
- `language::繁體中文`
- `origin::PixivFanbox`
- `mode::SFW`, `mode::NSFW`
- `category::動作`, `category::劇情`
- `ai-translated::true`（AI 翻譯內容）
- `ai-generated::true`（AI 生成內容）

**標籤功能**：
- 透過標籤搜尋、排序、分類
- 修改、新增、刪除標籤
- 多標籤組合查詢（AND / OR）
- 標籤自動補全建議

---

### 3. 影片功能

#### 媒體來源掃描
- 系統啟動時自動掃描配置的資料夾
- 支援手動觸發重新掃描
- 可選：定時自動掃描新檔案
- 排除系統檔案和快取資料夾
- 掃描進度即時顯示
- 檔案變更偵測（新增、刪除、移動）

#### 播放功能
- 支援 HLS 串流播放
- AES-128 加密保護
- **鍵盤快捷鍵**：
  - 左右鍵：快轉/倒退 10 秒
  - 上下鍵：快轉/倒退 60 秒
  - `l` 鍵：AB-loop 功能
  - `cmd/ctrl + 上下鍵`：切換同標籤的上/下一部影片
- 預設單檔循環播放
- 記錄觀看進度（斷點續播）
- **首幀顯示時間**：
  - 最愛影片（已轉碼）：< 1 秒
  - 非最愛影片（即時轉碼）：2-4 秒
- **即時轉碼提示**（可選）：
  - 顯示「準備中...」或轉碼進度
  - 已轉碼部分顯示為綠色，未轉碼為灰色

#### 上傳功能
- 支援拖拽上傳或選擇檔案
- 支援格式：mp4, mkv, avi, mov, webm
- 單檔大小上限：10GB
- 上傳時可設定標籤
- 上傳後自動觸發轉碼（加入佇列）
- 顯示上傳進度和轉碼狀態

#### 最愛功能
- 加入最愛：
  - 完整轉碼多種解析度（ABR）
  - 永久儲存於 NAS
- 移除最愛：
  - 保留已轉碼檔案（可設定是否刪除）
- 最愛列表獨立顯示

#### 轉碼策略

**最愛影片**：
- 完整轉碼並永久保存於 HDD
- 支援多解析度（1080p + 720p）
- ABR 自動切換

**非最愛影片（即時轉碼）**：
- 用戶點擊播放時，立即啟動轉碼
- **邊轉碼邊播放**：
  - 第一個片段（4 秒）轉完即可開始播放
  - 播放器自動載入後續片段
  - 只要轉碼速度 ≥ 播放速度，即可流暢觀看
- 首幀顯示時間：2-4 秒
- 轉碼完成後快取於 Ramdisk（LRU 策略）
- 再次播放直接從快取讀取（無等待）

**用戶體驗**：
- 最愛影片：立即播放（< 1 秒）
- 非最愛影片（有快取）：立即播放
- 非最愛影片（需轉碼）：等待 2-4 秒後開始播放
- 轉碼中顯示進度提示（可選）
- 支援播放進度記錄（斷點續播）

**技術規格**：
- Segment Duration：4 秒
- 影片切片格式：MPEG-TS
- Playlist 格式：HLS (m3u8)

---

### 4. 圖片功能

#### 媒體來源掃描
- 與影片功能共用掃描機制
- 自動識別圖片檔案類型
- 支援連續編號圖片自動分組（漫畫）

#### 瀏覽功能
- 支援單張圖片或多張連續漫畫
- **鍵盤快捷鍵**：
  - 左右鍵：上/下一張（或漫畫的上/下一頁）
  - `cmd/ctrl + 上下鍵`：切換同標籤的上/下一個作品
- 支援縮放、全螢幕檢視
- 漫畫模式支援連續捲動或分頁模式

#### 上傳功能
- 支援格式：jpg, png, gif, webp
- 單檔大小上限：20MB
- 批次上傳（一次多張）
- 上傳時可設定標籤
- 上傳時可指定是否為連續漫畫
- 自動生成縮圖

#### AI 翻譯功能（第二階段）
- 一鍵翻譯漫畫圖片為繁體中文
- 翻譯後存成新檔案（不覆蓋原檔）
- 複製原標籤並加上語言和 AI 翻譯標籤
- 翻譯伺服器跑在 Desktop (GPU 加速)
- 參考專案：manga-image-translator

---

### 5. 文章功能

#### 閱讀功能
- 支援 Markdown 渲染
- 支援程式碼高亮
- 支援目錄導航
- **書籤功能**：
  - 可針對單行設定跳轉書籤
  - 書籤列表快速跳轉
  - 書籤可命名和排序

#### 上傳與編輯功能
- **上傳**：
  - 支援 .txt, .md 檔案
  - 單檔大小上限：5MB
  - 上傳時可設定標籤
- **編輯**：
  - 簡易 Markdown 編輯器
  - 即時預覽
  - 支援插入圖片
  - 支援儲存為新版本（保留編輯歷史）
  - 自動儲存草稿

#### 簡繁轉換功能（第三階段）
- 一鍵將簡體中文轉換為繁體中文
- 透過 AI 補全用字（發/髮、乾/幹/干、后/後等）
- 轉換後存成新檔案
- 複製原標籤並加上語言和轉換標籤

---

### 6. ComfyUI 整合（第四階段）

- 安全模式下不顯示非安全模式的 workflow 和圖片
- 透過網頁上傳模型、Lora、ControlNet 等
- 上傳的模型儲存在 Desktop
- 產出的圖片和影片：
  - 自動同步到多媒體瀏覽器
  - 自動加上標籤：`origin::ComfyUI`, `ai-generated::true`
  - 可手動補充其他標籤
- 伺服器跑在 Desktop (GPU 加速)

---

### 7. Grafana 監控（第五階段）

#### 監控項目
1. **Desktop 資源監控**：
   - CPU 溫度、使用率
   - GPU 負載、溫度、記憶體使用
   - RAM、硬碟使用情況

2. **UPS 狀態監控**：
   - 電池電量、負載
   - 輸入/輸出電壓
   - 預估可用時間

#### 資料保留策略
- **原始資料**（10 秒採樣）：保留 30 天
- **10 分鐘聚合**：保留 1 年
- **1 小時聚合**：保留 5 年
- **預估儲存空間**：約 10GB

---

## 技術選型

### 前端技術
- **框架**：React Router v7（data mode, client-side render）
- **UI 套件**：Ant Design 5.x
- **狀態管理**：Redux Toolkit
- **影片播放器**：hls.js（輕量、專注 HLS）
- **API 通訊**：GraphQL (Apollo Client)
- **語言**：TypeScript

**選擇理由**：
- React Router v7 data mode：最新路由方案，CSR 適合私人應用
- Ant Design：減少 CSS 開發工作量
- hls.js：比 video.js 輕量 2.5 倍，專注 HLS 效能更好

---

### 後端技術

#### 核心服務（NAS）
- **語言**：Node.js + TypeScript
- **API**：GraphQL (Apollo Server)
- **資料庫**：PostgreSQL
- **快取**：Redis
- **反向代理**：Caddy（HTTP，統一入口）

**選擇理由**：
- Caddy：配置極簡，統一管理多服務入口
- 區網優先：專注核心功能開發，簡化架構
- 未來擴展：加入 Cloudflare Tunnel 即可上公網

#### 影片轉碼
- **工具**：FFmpeg
- **佇列管理**：Bull (Redis-based)
- **加密**：HLS AES-128

#### Desktop 服務（WSL2 + Docker）
- **ComfyUI**：GPU 加速
- **AI 翻譯**：manga-image-translator, GPU 加速

#### 監控系統（NAS）
- **架構**：Telegraf + InfluxDB + Grafana
- **優化**：WAL 寫入 Ramdisk，資料持久化到磁碟

---

## 安全性要求

### 網路層安全
- **區網階段**：
  - HTTP 訪問（不開放任何 Router Port）
  - 僅區網內裝置可訪問
- **未來公網階段**（可選）：
  - Cloudflare Tunnel（零信任架構）
  - 自動 HTTPS
  - DDoS 防護

### 應用層安全
- **認證**：Email OTP + Session Cookie
- **授權**：JWT token 驗證
- **加密**：HLS AES-128
- **CORS**：限制允許的來源
- **Rate Limiting**：防止暴力破解和濫用
- **檔案上傳限制**：
  - 類型白名單（防止惡意檔案）
  - 大小限制（影片 10GB, 圖片 20MB, 文章 5MB）
  - 檔名過濾（防止路徑遍歷攻擊）

### 備份策略
- **資料庫**：每日自動備份，保留 7 天
- **媒體檔案**：原始檔案為主，重要內容手動備份至外接硬碟
- **設定檔**：版本控制（Git）

---

## 效能要求

### 影片播放
- **首幀顯示**：
  - 最愛影片（已轉碼）：< 1 秒
  - 非最愛影片（即時轉碼）：2-4 秒
  - 非最愛影片（有快取）：< 1 秒
- **串流品質**：支援 ABR 自動切換（1080p/720p）
- **同時觀看**：支援 3-5 個同時串流（含即時轉碼任務）
- **轉碼效能**：1080p → 720p 轉碼速度約 1x 實時速度

### 資料查詢
- **列表查詢**：< 500ms（含標籤篩選）
- **搜尋查詢**：< 1s（全文搜尋）

### 轉碼效能
- **即時轉碼**：1 部影片同時轉碼，其他加入佇列
- **背景轉碼**：最愛影片自動轉碼，不影響使用者體驗

### 系統資源
- **Ramdisk**：6GB（NAS 總記憶體 10GB 的 60%）
  - Redis 快取：500MB
  - 影片快取：4GB（約 40-80 部）
  - 資料庫寫入緩衝：1GB
  - 臨時檔案：500MB
- **系統保留**：4GB（Synology DSM + Docker 容器）

---

## 開發階段

### 第一階段：核心功能（區網測試）

**環境準備**：
- NAS Ramdisk 設定（6GB）
- Caddy 安裝與設定（HTTP）
- Gmail App Password 生成

**核心功能**：
- 媒體來源掃描與索引
- Email OTP 登入
- Session 管理
- 安全模式切換
- 影片上傳
- 影片播放（HLS + AES-128）
- 轉碼服務（FFmpeg + Bull Queue）
- 最愛功能
- 標籤系統（CRUD + 搜尋）

**部署**：
- Caddy 反向代理（HTTP，port 8080）
- 區網訪問測試：`http://192.168.50.100:8080`

---

### 第二階段：WebAuthn + 圖片功能

- WebAuthn 認證（解鎖非安全模式）
- 圖片上傳與瀏覽
- 漫畫模式（連續捲動/分頁）
- AI 翻譯整合（manga-image-translator）

---

### 第三階段：文章功能

- 文章上傳與閱讀
- Markdown 編輯器（即時預覽）
- 書籤系統
- 簡繁轉換 + AI 用字補全

---

### 第四階段：ComfyUI 整合

- ComfyUI 伺服器建置（Desktop WSL2）
- 模型上傳功能
- 產出內容同步到媒體庫

---

### 第五階段：Grafana 監控

- Telegraf + InfluxDB + Grafana 建置
- 資料降採樣設定（30天/1年/5年）
- Desktop 資源監控 Dashboard
- UPS 監控整合
- Dashboard 備份

---

### 第六階段：公網訪問（可選）

- Cloudflare Tunnel 設定
- AWS Route53 DNS 設定
- Caddy 啟用 HTTPS
- 網域：`media.bill42362.net`
- 連線測試

---

## 附註

### 使用場景
- **個人使用**：簡化權限系統，無需複雜的多使用者管理
- **區網訪問**：透過 Caddy 統一入口，HTTP 訪問
- **未來公網**（可選）：透過 Cloudflare Tunnel 安全訪問，無需 VPN

### 擴展性考量
- 影片數量可擴展到數萬部
- 標籤系統支援未來加入 AI 自動標籤
- 架構支援未來增加更多媒體類型
