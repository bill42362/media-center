# Media Center 系統規格書

## 目錄
1. [系統概述](#系統概述)
2. [硬體環境](#硬體環境)
3. [功能需求](#功能需求)
4. [技術選型](#技術選型)
5. [安全性要求](#安全性要求)
6. [效能要求](#效能要求)
7. [開發階段](#開發階段)

---

## 系統概述

本系統為私人媒體中心，提供影片、圖片、文章的管理、瀏覽、播放功能，並整合 AI 翻譯、ComfyUI 創作工具、Grafana 監控等功能。

### 核心特色
- 🏷️ 多重標籤系統（namespace::value 格式）
- 🔒 安全模式切換（SFW/NSFW 內容分離）
- 🎬 影片加密串流
- 🤖 AI 輔助翻譯（圖片漫畫、文章簡繁轉換）
- 🎨 整合 ComfyUI 用於 AI 圖片創作
- 📊 系統監控（Desktop 資源 + UPS 狀態）

### 內容規模
- **影片**：約 3000 部
- **圖片**：約 30000 張
- **文章**：約 500 篇

---

## 硬體環境

### 主要設備

| 設備 | 規格 | 用途 |
|------|------|------|
| **NAS** | Synology DS420+<br>RAM: 10GB | 主要伺服器、資料庫、媒體儲存 |
| **Desktop** | Windows<br>GPU: RTX 2080Ti<br>WSL2 + Docker | ComfyUI 伺服器、AI 翻譯伺服器 |
| **Router** | ASUS RT-AX56U<br>Firmware: Merlin 3004.388.6_2 | 網路管理 |
| **UPS** | APC Back-UPS NS 650M1 | 停電保護、狀態監控 |

### 網路架構
- **區網訪問**：`http://192.168.50.100:8080`（Caddy 統一入口）
- **反向代理**：Caddy
  - `/` → Media Center (port 3000)
  - `/comfyui` → ComfyUI (未來)
  - `/grafana` → Grafana (未來)
- **未來公網**（可選）：
  - Cloudflare Tunnel（零信任架構）
  - 不開放任何 Router Port
  - 自動 HTTPS

### 儲存規劃
- **媒體來源**：支援多個資料夾作為媒體來源
  - 範例：`/volume1/media/`, `/volume1/downloads/`, `/volume1/family/`
  - 透過配置檔案管理，無需修改程式碼
  - 新增資料夾後重啟服務即可生效
- **轉碼結果**：
  - 最愛影片：永久儲存於 HDD
  - 非最愛影片：快取於 Ramdisk (6GB)
- **Ramdisk 用途**：
  - Session 和快取資料
  - 非最愛影片 HLS 切片（約可快取 40-80 部）
  - 資料庫寫入緩衝（Grafana 時間序列資料）

---

## 功能需求

### 1. 認證與授權

#### 使用者管理
- **管理員**：
  - 透過 Email 白名單指定（單一 Email）
  - 擁有完整權限
- **一般使用者**：
  - 透過 Email 白名單指定（多個 Email）
  - 唯讀權限 + 基本個人化功能
- **白名單配置**：
  - 透過配置檔案管理
  - 修改後重啟服務即可生效
  - Email 不在白名單中無法登入

#### Email OTP 登入
- 使用者輸入 Email，系統發送 6 位數 OTP
- OTP 有效期限：10 分鐘
- 使用 Gmail SMTP 發送郵件
- 登入後建立 Session
- 根據 Email 自動分配角色（管理員或一般使用者）
- 未登入使用者無法觀看任何內容

#### 權限分級

| 功能 | 管理員 | 一般使用者 |
|------|--------|-----------|
| 瀏覽內容 | 全部內容 | 僅 SFW 內容 |
| 安全模式切換 | ✅ | ❌ |
| 上傳影片/圖片 | ✅ | ❌ |
| 編輯標籤 | ✅ | ❌ |
| 新增最愛 | ✅ 無限制 | ✅ 有數量限制 |
| 觀看進度 | ✅ | ✅ |
| 播放影片 | ✅ | ✅ |

#### 安全模式
- **管理員**：
  - 安全模式 (SFW)：只顯示 `mode::SFW` 標籤的內容
  - 非安全模式：顯示所有內容
  - 切換至非安全模式需要再次 OTP 驗證或 WebAuthn
- **一般使用者**：
  - 永遠處於安全模式 (SFW)
  - 無法切換至非安全模式
  - 無法看到 NSFW 內容

#### WebAuthn（第二階段）
- 支援平台認證器（Touch ID, Face ID, Windows Hello）
- 管理員用於快速解鎖非安全模式
- 一般使用者無此功能

---

### 2. 標籤系統

所有內容都支援多重標籤，格式：`namespace::value`

**標籤範例**：
- `author::手塚治虫`
- `director::Ang Lee`
- `language::繁體中文`
- `origin::PixivFanbox`
- `mode::SFW`, `mode::NSFW`
- `category::動作`, `category::劇情`
- `ai-translated::true`（AI 翻譯內容）
- `ai-generated::true`（AI 生成內容）

**標籤功能**：
- 透過標籤搜尋、排序、分類（所有使用者）
- 多標籤組合查詢（AND / OR）（所有使用者）
- 標籤自動補全建議（所有使用者）
- 修改、新增、刪除標籤（僅管理員）
- 一般使用者標籤為唯讀

---

### 3. 影片功能

#### 媒體來源掃描
- 系統啟動時自動掃描配置的資料夾
- 支援手動觸發重新掃描
- 可選：定時自動掃描新檔案
- 排除系統檔案和快取資料夾
- 掃描進度即時顯示
- 檔案變更偵測（新增、刪除、移動）

#### 播放功能
- 支援 HLS 串流播放
- AES-128 加密保護
- **鍵盤快捷鍵**：
  - 左右鍵：快轉/倒退 10 秒
  - 上下鍵：快轉/倒退 60 秒
  - `l` 鍵：AB-loop 功能
  - `cmd/ctrl + 上下鍵`：切換同標籤的上/下一部影片
- 預設單檔循環播放
- 記錄觀看進度（斷點續播）
- **首幀顯示時間**：
  - 最愛影片（已轉碼）：< 1 秒
  - 非最愛影片（即時轉碼）：2-4 秒
- **即時轉碼提示**（可選）：
  - 顯示「準備中...」或轉碼進度
  - 已轉碼部分顯示為綠色，未轉碼為灰色

#### 上傳功能（僅管理員）
- 支援拖拽上傳或選擇檔案
- 支援格式：mp4, mkv, avi, mov, webm
- 單檔大小上限：10GB
- 上傳時可設定標籤
- 上傳後自動觸發轉碼（加入佇列）
- 顯示上傳進度和轉碼狀態
- 一般使用者無上傳功能

#### 最愛功能
- **管理員**：
  - 無數量限制
  - 加入最愛：完整轉碼多種解析度（ABR），永久儲存於 NAS
  - 移除最愛：保留已轉碼檔案（可設定是否刪除）
- **一般使用者**：
  - 有數量限制（例如 100 部）
  - 達到上限時無法新增，需先移除舊的
  - 移除最愛不影響檔案儲存
- 最愛列表為個人專屬（不同使用者看到不同列表）

#### 觀看紀錄
- **自動記錄**：
  - 系統自動記錄每次觀看行為（後台運作）
  - 記錄開始時間、結束時間、觀看時長
  - 記錄播放範圍（從第幾秒到第幾秒）
  - 使用者完全無感知，僅用於管理分析

- **用途**（後續階段開發管理介面）：
  - 管理員查詢特定使用者的觀看歷程
  - 管理員查詢特定影片被誰看過
  - 分析觀看習慣和熱門內容
  - 系統使用情況統計

- **權限限制**：
  - **僅管理員**可查看所有觀看記錄
  - **一般使用者**無法查看任何觀看紀錄（包含自己的）
  - 一般使用者只有「斷點續播」功能（最新進度）
  - 定期清理舊資料（保留 1 年）

- **與斷點續播的差異**：
  - 觀看紀錄：完整的歷史記錄（多筆），僅管理員可見
  - 斷點續播：最新的播放進度（單筆），所有使用者可用

#### 轉碼策略

**最愛影片**：
- 完整轉碼並永久保存於 HDD
- 支援多解析度（1080p + 720p）
- ABR 自動切換
- 首幀顯示時間：< 1 秒

**非最愛影片（分階段轉碼）**：
用戶點擊播放時，採用兩階段策略提升體驗：

- **第一階段（高優先級 - 720p）**：
  - 立即開始轉碼 720p 版本
  - 首幀顯示時間：1-2 秒
  - 轉碼速度快（1.5-2x 實時速度）
  - 用戶可以立即開始觀看

- **第二階段（背景低優先級 - 1080p）**：
  - 720p 轉碼完成後，自動在背景轉 1080p
  - 不影響當前播放體驗
  - 完成後下次播放自動使用 1080p
  - 前端可顯示「正在準備高畫質版本...」提示

- **快取機制**：
  - 轉碼完成後儲存於 Ramdisk（LRU 策略）
  - 保留最近播放的 64 部影片
  - 再次播放直接從快取讀取（無等待）
  - Ramdisk 空間不足時優先刪除 1080p 版本

**用戶體驗流程**：

1. **首次播放**（無快取）：
   - 點擊播放 → 等待 1-2 秒 → 開始播放 720p
   - 播放中顯示「背景準備 1080p 中...」（可選）
   - 1080p 完成後提示「更高畫質已就緒」（可選）

2. **再次播放**（有 720p 快取）：
   - 點擊播放 → 立即播放 720p
   - 背景檢查是否需要補轉 1080p

3. **再次播放**（有 1080p 快取）：
   - 點擊播放 → 立即播放 1080p
   - 最佳體驗

4. **加入最愛**：
   - 自動從 Ramdisk 移動到永久儲存
   - 如只有 720p，補轉 1080p 並建立 ABR
   - 下次播放享受最愛影片的完整體驗

**技術規格**：
- 720p Segment Duration：2 秒（優先首幀速度）
- 1080p Segment Duration：4 秒（平衡品質）
- 影片切片格式：MPEG-TS
- Playlist 格式：HLS (m3u8)
- 同時轉碼限制：720p 1 個 + 1080p 1 個（最多 2 個任務）

---

### 4. 圖片功能

#### 媒體來源掃描
- 與影片功能共用掃描機制
- 自動識別圖片檔案類型
- 支援連續編號圖片自動分組（漫畫）

#### 瀏覽功能
- 支援單張圖片或多張連續漫畫
- **鍵盤快捷鍵**：
  - 左右鍵：上/下一張（或漫畫的上/下一頁）
  - `cmd/ctrl + 上下鍵`：切換同標籤的上/下一個作品
- 支援縮放、全螢幕檢視
- 漫畫模式支援連續捲動或分頁模式

#### 上傳功能（僅管理員）
- 支援格式：jpg, png, gif, webp
- 單檔大小上限：20MB
- 批次上傳（一次多張）
- 上傳時可設定標籤
- 上傳時可指定是否為連續漫畫
- 自動生成縮圖
- 一般使用者無上傳功能

#### AI 翻譯功能（第二階段）
- 一鍵翻譯漫畫圖片為繁體中文
- 翻譯後存成新檔案（不覆蓋原檔）
- 複製原標籤並加上語言和 AI 翻譯標籤
- 翻譯伺服器跑在 Desktop (GPU 加速)
- 參考專案：manga-image-translator

---

### 5. 文章功能

#### 閱讀功能
- 支援 Markdown 渲染
- 支援程式碼高亮
- 支援目錄導航
- **書籤功能**：
  - 可針對單行設定跳轉書籤
  - 書籤列表快速跳轉
  - 書籤可命名和排序

#### 上傳與編輯功能（僅管理員）
- **上傳**：
  - 支援 .txt, .md 檔案
  - 單檔大小上限：5MB
  - 上傳時可設定標籤
- **編輯**：
  - 簡易 Markdown 編輯器
  - 即時預覽
  - 支援插入圖片
  - 支援儲存為新版本（保留編輯歷史）
  - 自動儲存草稿
- 一般使用者僅可閱讀，無上傳和編輯功能

#### 簡繁轉換功能（第三階段）
- 一鍵將簡體中文轉換為繁體中文
- 透過 AI 補全用字（發/髮、乾/幹/干、后/後等）
- 轉換後存成新檔案
- 複製原標籤並加上語言和轉換標籤

---

### 6. ComfyUI 整合（第四階段）

#### 雙實例架構
系統提供兩個獨立的 ComfyUI 實例，分別給管理員和一般使用者使用：

**實例配置**：
- **管理員實例**（/comfyui/admin）：
  - 可使用所有模型（包含 NSFW）
  - 可建立和使用所有類型的工作流
  - 獨立的輸出資料夾
  - 可存取一般使用者的實例（檢視工作流、輸出）

- **一般使用者實例**（/comfyui/user）：
  - 可使用所有模型（共享，管理員上傳）
  - 只能建立和使用 SFW 工作流
  - 獨立的輸出資料夾
  - 無法存取管理員的實例

**模型管理**：
- 所有模型、Lora、ControlNet 完全共享
- 管理員透過網頁介面上傳模型
- 上傳後兩個實例都能立即使用
- 模型儲存在 Desktop 共享資料夾
- 節省硬碟空間（避免重複儲存）

**GPU 互斥執行**：
- RTX 2080Ti 一次只能執行一個 ComfyUI 任務
- 使用佇列系統管理任務：
  - 當管理員實例執行任務時，使用者實例任務自動排隊
  - 當使用者實例執行任務時，管理員實例任務自動排隊
  - 管理員任務優先級較高
- 前端顯示佇列狀態：
  - 「執行中...」
  - 「排隊等候... (前方 1 個任務)」
  - 「完成」

**權限控制**：
- **管理員**：
  - 登入後可看到兩個進入點：
    - 「我的 ComfyUI」（/comfyui/admin）
    - 「使用者 ComfyUI」（/comfyui/user）
  - 可切換查看兩個實例的工作流和輸出
  - 可上傳模型

- **一般使用者**：
  - 登入後只看到一個進入點：
    - 「ComfyUI」（/comfyui/user）
  - 無法看到管理員的工作流和輸出
  - 無法上傳模型

**產出內容管理**：
- 產出的圖片和影片自動同步到媒體庫
- 自動加上標籤：
  - `origin::ComfyUI`
  - `ai-generated::true`
  - `author::{使用者 Email}`
  - 管理員產出的內容可選 `mode::SFW` 或 `mode::NSFW`
  - 一般使用者產出的內容自動標記為 `mode::SFW`
- 可手動補充其他標籤（僅管理員）

**技術規格**：
- 伺服器運行在 Desktop (GPU 加速)
- 使用 Docker Compose 管理兩個實例
- 模型共享透過唯讀掛載實現
- GPU 互斥透過 Bull Queue + Redis 分散式鎖實現

---

### 7. Grafana 監控（第二階段）

#### 部署位置
- **伺服器位置**：NAS（24/7 運作，統一管理）
- **資料收集**：
  - NAS：Telegraf 本地收集
  - Desktop：Telegraf 遠端推送到 NAS 的 InfluxDB

#### 監控項目

1. **NAS 資源監控**（Synology DS420+）：
   - CPU 使用率、溫度
   - RAM 使用情況（總計 10GB，含 Ramdisk 6GB）
   - 硬碟使用情況、I/O 效能
   - 網路流量（上傳/下載）
   - Docker 容器狀態
   - 使用現成的 Synology Dashboard（Grafana ID: 928, 5955）

2. **Desktop 資源監控**：
   - CPU 溫度、使用率
   - GPU 負載、溫度、記憶體使用
   - RAM、硬碟使用情況
   - 轉碼任務負載
   - 使用現成的 Docker Dashboard（Grafana ID: 193）

3. **UPS 狀態監控**：
   - 電池電量、負載
   - 輸入/輸出電壓
   - 預估可用時間
   - 透過 NUT (Network UPS Tools) 整合

#### 記憶體優化策略
考量 NAS 總記憶體 10GB（6GB Ramdisk + 4GB 系統），採用以下優化：

- **Docker 記憶體限制**：
  - InfluxDB: 256MB
  - Grafana: 128MB
  - Telegraf: 無需限制（記憶體佔用極小）

- **設定優化**：
  - 使用輕量化配置
  - 優先使用社群現成 Dashboard（減少複雜查詢）
  - WAL 寫入 Ramdisk，資料持久化到磁碟

- **降採樣策略**：
  - 減少長期資料儲存量
  - 降低查詢負載

- **備用方案**：
  - 若記憶體仍不足，可將 Ramdisk 從 6GB 降至 5GB
  - 避免在轉碼高峰期查詢 Grafana

#### 資料保留策略
- **原始資料**（10 秒採樣）：保留 30 天
- **10 分鐘聚合**：保留 1 年
- **1 小時聚合**：保留 5 年
- **預估儲存空間**：約 10GB

---

## 技術選型

### 前端技術
- **框架**：React Router v7（data mode, client-side render）
- **UI 套件**：Ant Design 5.x
- **狀態管理**：Redux Toolkit
- **影片播放器**：hls.js（輕量、專注 HLS）
- **API 通訊**：GraphQL (Apollo Client)
- **語言**：TypeScript

**選擇理由**：
- React Router v7 data mode：最新路由方案，CSR 適合私人應用
- Ant Design：減少 CSS 開發工作量
- hls.js：比 video.js 輕量 2.5 倍，專注 HLS 效能更好

---

### 後端技術

#### 核心服務（NAS）
- **語言**：Node.js + TypeScript
- **API**：GraphQL (Apollo Server)
- **資料庫**：PostgreSQL
- **快取**：Redis
- **反向代理**：Caddy（HTTP，統一入口）

**選擇理由**：
- Caddy：配置極簡，統一管理多服務入口
- 區網優先：專注核心功能開發，簡化架構
- 未來擴展：加入 Cloudflare Tunnel 即可上公網

#### 影片轉碼
- **工具**：FFmpeg
- **佇列管理**：Bull (Redis-based)
- **加密**：HLS AES-128

#### Desktop 服務（WSL2 + Docker）
- **ComfyUI**：GPU 加速
- **AI 翻譯**：manga-image-translator, GPU 加速

#### 監控系統（NAS）
- **架構**：Telegraf + InfluxDB + Grafana
- **優化**：WAL 寫入 Ramdisk，資料持久化到磁碟

---

## 安全性要求

### 網路層安全
- **區網階段**：
  - HTTP 訪問（不開放任何 Router Port）
  - 僅區網內裝置可訪問
- **未來公網階段**（可選）：
  - Cloudflare Tunnel（零信任架構）
  - 自動 HTTPS
  - DDoS 防護

### 應用層安全
- **認證**：Email OTP + Session Cookie
- **授權**：JWT token 驗證
- **加密**：HLS AES-128
- **CORS**：限制允許的來源
- **Rate Limiting**：防止暴力破解和濫用
- **檔案上傳限制**：
  - 類型白名單（防止惡意檔案）
  - 大小限制（影片 10GB, 圖片 20MB, 文章 5MB）
  - 檔名過濾（防止路徑遍歷攻擊）

### 備份策略
- **資料庫**：每日自動備份，保留 7 天
- **媒體檔案**：原始檔案為主，重要內容手動備份至外接硬碟
- **設定檔**：版本控制（Git）

---

## 效能要求

### 影片播放
- **首幀顯示**：
  - 最愛影片（已轉碼）：< 1 秒
  - 非最愛影片（首次播放 720p）：1-2 秒
  - 非最愛影片（有快取）：< 1 秒
  - 1080p 版本準備時間：背景執行，不影響播放
- **串流品質**：
  - 最愛影片：ABR 自動切換（1080p/720p）
  - 非最愛影片：初次為 720p，快取後升級為 1080p
- **同時觀看**：支援 3-5 個同時串流
- **轉碼效能**：
  - 720p 高優先級：1.5-2x 實時速度
  - 1080p 低優先級：0.8-1.2x 實時速度
  - 同時轉碼上限：720p 1 個 + 1080p 1 個

### 資料查詢
- **列表查詢**：< 500ms（含標籤篩選）
- **搜尋查詢**：< 1s（全文搜尋）

### 轉碼效能
- **高優先級轉碼（720p）**：
  - 同時最多 1 個任務
  - 轉碼速度：1.5-2x 實時速度
  - 首幀時間：1-2 秒
  - 用於非最愛影片首次播放

- **低優先級轉碼（1080p）**：
  - 同時最多 1 個任務
  - 轉碼速度：0.8-1.2x 實時速度
  - 背景執行，不阻塞播放
  - 用於非最愛影片升級和最愛影片

- **佇列管理**：
  - 高優先級和低優先級各自獨立佇列
  - 總計最多 2 個同時轉碼任務（1 高 + 1 低）
  - 其他任務自動排隊等待

### 系統資源
- **Ramdisk**：6GB（NAS 總記憶體 10GB 的 60%）
  - Redis 快取：500MB
  - 影片快取：4GB（約 40-80 部）
  - 資料庫寫入緩衝：1GB
  - 臨時檔案：500MB
- **系統保留**：4GB（Synology DSM + Docker 容器）

---

## 開發階段

### 第一階段：核心功能（區網測試）

**環境準備**：
- NAS Ramdisk 設定（6GB）
- Caddy 安裝與設定（HTTP）
- Gmail App Password 生成

**核心功能**：
- 媒體來源掃描與索引
- Email OTP 登入
- Session 管理
- 安全模式切換
- 影片上傳
- 影片播放（HLS + AES-128）
- 轉碼服務（FFmpeg + Bull Queue）
- 最愛功能
- 標籤系統（CRUD + 搜尋）

**部署**：
- Caddy 反向代理（HTTP，port 8080）
- 區網訪問測試：`http://192.168.50.100:8080`

---

### 第二階段：Grafana 監控

**部署架構**：
- 全部署在 NAS（24/7 監控，統一管理）
- Desktop 透過 Telegraf 推送資料到 NAS

**實作項目**：
- Telegraf + InfluxDB + Grafana 建置
- Docker 記憶體限制設定（InfluxDB: 256MB, Grafana: 128MB）
- 資料降採樣設定（30天/1年/5年）
- **NAS 資源監控**：
  - 使用 Telegraf 收集系統資源
  - 匯入現成的 Synology Dashboard（Grafana ID: 928, 5955）
  - 監控 CPU、RAM（含 Ramdisk）、Disk I/O、Network、Docker
- **Desktop 資源監控**：
  - 使用 Telegraf 收集 GPU/CPU 資料
  - 匯入現成的 Docker Dashboard（Grafana ID: 193）
  - 監控 GPU 負載、溫度、VRAM
- **UPS 監控整合**：
  - 透過 NUT (Network UPS Tools)
  - 使用現成的 UPS Dashboard
- Dashboard 備份與版本控制

---

### 第三階段：WebAuthn + 圖片功能

- WebAuthn 認證（解鎖非安全模式）
- 圖片上傳與瀏覽
- 漫畫模式（連續捲動/分頁）
- AI 翻譯整合（manga-image-translator）

---

### 第四階段：文章功能

- 文章上傳與閱讀
- Markdown 編輯器（即時預覽）
- 書籤系統
- 簡繁轉換 + AI 用字補全

---

### 第五階段：ComfyUI 整合

- ComfyUI 伺服器建置（Desktop WSL2）
- 模型上傳功能
- 產出內容同步到媒體庫

---

### 第六階段：公網訪問（可選）

- Cloudflare Tunnel 設定
- AWS Route53 DNS 設定
- Caddy 啟用 HTTPS
- 網域：`media.bill42362.net`
- 連線測試

---

## 附註

### 使用場景
- **多使用者共享**：
  - 管理員（1 人）：完整權限，管理內容
  - 一般使用者（2-3 人）：唯讀 + 基本個人化
  - 適合家人、朋友共用
- **權限簡化**：
  - Email 白名單管理，無需註冊介面
  - 角色自動分配，無需手動設定
- **區網訪問**：透過 Caddy 統一入口，HTTP 訪問
- **未來公網**（可選）：透過 Cloudflare Tunnel 安全訪問，無需 VPN

### 擴展性考量
- 影片數量可擴展到數萬部
- 標籤系統支援未來加入 AI 自動標籤
- 架構支援未來增加更多媒體類型
